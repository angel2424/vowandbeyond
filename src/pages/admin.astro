---
import '../styles/global.css'
export const prerender = false

import { getSupabaseAuthedClient } from '../lib/supabase'
import { CircleCheck, X, Download, User } from '@lucide/astro'

const access = Astro.cookies.get('sb-access-token')?.value
if (!access) return Astro.redirect('/login')

const supabase = getSupabaseAuthedClient(access)

const {
  data: { user },
  error: userErr,
} = await supabase.auth.getUser()
if (userErr || !user) return Astro.redirect('/login')

const { data: rsvps, error } = await supabase
  .from('rsvps')
  .select('*')
  .order('created_at', { ascending: false })
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=IBM+Plex+Serif:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Panel de invitados | Boda Rosaura &amp; José</title>
    <meta
      name="description"
      content="Administra las confirmaciones y la lista de invitados de la boda de José y Rosaura desde este panel privado."
    />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Panel de invitados | Boda Rosaura & José" />
    <meta
      property="og:description"
      content="Panel privado para revisar y exportar las confirmaciones de asistencia de la boda."
    />
    <meta property="og:image" content="/favicon.svg" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Panel de invitados | Boda Rosaura & José" />
    <meta
      name="twitter:description"
      content="Gestiona las confirmaciones de la boda de José y Rosaura en un solo lugar."
    />
    <meta name="theme-color" content="#00674f" />
  </head>
  <body>
    <main class="mx-auto flex min-h-screen max-w-5xl flex-col justify-between px-8 py-20">
      <div class="mb-12 flex items-center justify-between">
        <h1 class="text-brand-600 text-xl font-medium">Boda de Rosaura & José</h1>
        <form method="POST" action="/api/logout">
          <button
            type="submit"
            class={`border-2 uppercase hover:scale-[1.01] transition-[scale,color,border] ease-linear duration-150 cursor-pointer px-10 py-2 btn text-brand-500 border-brand-400 before:bg-brand-50! hover:text-brand-50 disabled:cursor-not-allowed disabled:opacity-70`}
          >
            <span>Cerrar sesión</span>
          </button>
        </form>
      </div>
      {error && <p>{error.message}</p>}
      {
        rsvps?.length ? (
          <div>
            <div class="mb-10 flex items-center justify-between">
              <h2 class="text-brand-900 text-2xl font-semibold">Invitados confirmados</h2>
              <div class="flex gap-3">
                <button
                  id="downloadPdf"
                  class="btn text-brand-500 border-brand-400 before:bg-brand-50! hover:text-brand-50 flex cursor-pointer items-center gap-2 border-2 px-6 py-2 uppercase transition-[scale,color,border] duration-150 ease-linear hover:scale-[1.01]"
                >
                  <span>PDF</span>
                </button>
                <button
                  id="downloadExcel"
                  class="btn text-brand-500 border-brand-400 before:bg-brand-50! hover:text-brand-50 flex cursor-pointer items-center gap-2 border-2 px-6 py-2 uppercase transition-[scale,color,border] duration-150 ease-linear hover:scale-[1.01]"
                >
                  <span>Excel</span>
                </button>
              </div>
            </div>
            <div class="bg-neutral-primary-soft rounded-base border-brand-200 relative overflow-x-auto border shadow-xs">
              <table class="text-body w-full text-left text-sm rtl:text-right" id="rsvpTable">
                <thead class="text-brand-600 bg-brand-50 rounded-base border-brand-200! border-b text-sm">
                  <tr>
                    <th scope="col" class="px-6 py-3 font-medium">
                      Nombre completo
                    </th>
                    <th scope="col" class="px-6 py-3 font-medium">
                      # de invitados
                    </th>
                    <th scope="col" class="px-6 py-3 font-medium">
                      Teléfono
                    </th>
                    <th scope="col" class="px-6 py-3 font-medium">
                      Nota
                    </th>
                    <th scope="col" class="px-6 py-3 font-medium">
                      Confirmado
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {rsvps?.map((rsvp) => {
                    return (
                      <tr
                        class="bg-neutral-primary border-default border-b"
                        data-attending={rsvp?.attending}
                      >
                        <th
                          scope="row"
                          class="text-heading px-6 py-4 font-medium whitespace-nowrap"
                        >
                          {rsvp?.full_name}
                        </th>
                        <td class="px-6 py-4">{rsvp?.guests_count}</td>
                        <td class="px-6 py-4">{rsvp?.phone}</td>
                        <td class="px-6 py-4">{rsvp?.notes || '-'}</td>
                        <td class="px-6 py-4">
                          {rsvp?.attending ? <CircleCheck class="text-brand-600" /> : <X />}
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </div>
        ) : (
          <div class="flex flex-col items-center justify-center gap-2 text-center">
            <User size={'2rem'} class="text-brand-600" />
            <p class="text-lg text-gray-600">Aún no hay invitados confirmados.</p>
          </div>
        )
      }
      <div class="mt-10 flex items-center justify-between">
        <img
          src="https://storage.googleapis.com/joseyrosaura/alora-logo.svg"
          class="aspect-video h-auto w-20 object-contain"
          alt="Logo de Alora | Panel de confirmación de invitados"
        />
        <p class="text-xs text-gray-500">
          2026 Alora. Una plataforma de DevWorks Studio. Todos los derechos reservados.
        </p>
      </div>
    </main>

    <script is:inline>
      window.addEventListener('load', () => {
        const rows = document.querySelectorAll('#rsvpTable tbody tr')
        const rsvpData = Array.from(rows).map((row) => {
          const cells = row.querySelectorAll('th, td')
          const attending = row.getAttribute('data-attending') === 'true'

          return {
            nombre: cells[0]?.textContent?.trim() || '',
            invitados: cells[1]?.textContent?.trim() || '',
            telefono: cells[2]?.textContent?.trim() || '',
            nota: cells[3]?.textContent?.trim() || '',
            confirmado: attending ? 'Sí' : 'No',
          }
        })

        const pdfButton = document.getElementById('downloadPdf')
        const pdfLabel = pdfButton?.querySelector('span')

        pdfButton?.addEventListener('click', async () => {
          if (!pdfButton) return

          const originalText = pdfLabel?.textContent || 'PDF'
          pdfButton.disabled = true
          pdfButton.classList.add('opacity-70')
          if (pdfLabel) pdfLabel.textContent = 'Generando...'

          try {
            const response = await fetch('/api/rsvps/pdf')

            if (!response.ok) {
              throw new Error(`Respuesta inválida (${response.status})`)
            }

            const blob = await response.blob()
            const url = window.URL.createObjectURL(blob)
            const link = document.createElement('a')
            link.href = url
            link.download = 'invitados-boda.pdf'
            document.body.appendChild(link)
            link.click()
            link.remove()
            setTimeout(() => window.URL.revokeObjectURL(url), 1500)
          } catch (error) {
            console.error('Error generating PDF:', error)
            alert('No se pudo generar el PDF. Por favor inténtalo de nuevo.')
          } finally {
            pdfButton.disabled = false
            pdfButton.classList.remove('opacity-70')
            if (pdfLabel) pdfLabel.textContent = originalText
          }
        })

        // Excel Download
        const excelButton = document.getElementById('downloadExcel')
        const excelLabel = excelButton?.querySelector('span')

        excelButton?.addEventListener('click', async () => {
          if (!excelButton) return

          const originalText = excelLabel?.textContent || 'Excel'
          excelButton.disabled = true
          excelButton.classList.add('opacity-70')
          if (excelLabel) excelLabel.textContent = 'Generando...'

          try {
            const response = await fetch('/api/rsvps/excel')

            if (!response.ok) {
              throw new Error(`Respuesta inválida (${response.status})`)
            }

            const blob = await response.blob()
            const url = window.URL.createObjectURL(blob)
            const link = document.createElement('a')
            link.href = url
            link.download = 'invitados-boda.xlsx'
            document.body.appendChild(link)
            link.click()
            link.remove()
            setTimeout(() => window.URL.revokeObjectURL(url), 1500)
          } catch (error) {
            console.error('Error generating Excel:', error)
            alert('No se pudo generar el Excel. Por favor inténtalo de nuevo.')
          } finally {
            excelButton.disabled = false
            excelButton.classList.remove('opacity-70')
            if (excelLabel) excelLabel.textContent = originalText
          }
        })
      })
    </script>
  </body>
</html>
